@model List<FileInSystem>;
@{
    ViewData["Title"] = "AllFiles";
}

<section>
    <div class="row mt-2" id="FilesList">
        @foreach (var temp in Model)
        {
            <div class="File col-2 text-center mt-3" objId="@temp.Id">
                <i class="fas fa-file" style="font-size: 30px"></i>
                <p>
                    @temp.Name
                </p>
            </div>
        }
    </div>
</section>

<section>
    <div class="modal fade" id="Modal" tabindex="-1" role="dialog" aria-labelledby="Modal" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ModalTitle"></h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="fileId">Id файла:</label>
                        <input type="text" id="fileId" disabled class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="fileName">Имя файла:</label>
                        <input type="text" id="fileName" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="fileType">Тип файла:</label>
                        <input type="text" name="fileType" disabled class="form-control">
                    </div>
                    <div class="custom-control custom-switch">
                        <input type="checkbox" class="custom-control-input" id="confirmed">
                        <label class="custom-control-label" for="confirmed">Утвержден</label>
                    </div>
                    <div class="d-flex justify-content-between">
                        <button class="btn btn-dark mt-4 w-50 mr-2" onclick="DownloadFile()">Скачать</button>
                        <button class="btn btn-danger mt-4 w-50" onclick="DeleteFile()">Удалить</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
                    <button type="button" class="btn btn-primary">Сохранить изменения</button>
                </div>
            </div>
        </div>
    </div>
</section>

<script>

    function DownloadFile() {
        var win = window.open('/GetFileById?id=' + window.modalData.id);
        setTimeout("win.close()", 3000);
    }

    function DeleteFile() {
        var data = new FormData();
        data.append("id", window.modalData.id);

         $.ajax({
                type: "POST",
                url: "@Url.Action("DeleteFile", "Home")",
            contentType: false,
            processData: false,
            data: data,
            success: function () {
                toastr["success"]("Файл успешно удален");
            },
            error: function () {
                toastr["error"]("Произошла ошибка при удалении файла");
            },
            beforeSend: function () {
                $("#progress").show();
            },
            complete: function () {
                $("#progress").hide();
            }
        });
        $("#Modal").modal('hide');
        setTimeout("location.reload();", 300);
    }

    $(".fas.fa-file").on("click",
        function() {
            var id = $(this).parent().attr("objId");
            var data = new FormData();
            data.append("id", id);

            $.ajax({
                type: "POST",
                url: "@Url.Action("GetFileInfo", "Home")",
            contentType: false,
            processData: false,
            data: data,
            success: function (request) {
                window.modalData = request;
                $("#ModalTitle").text(request.name);

                $("#fileId").val(request.id);
                $("#fileName").val(request.name);
                $("#fileType").val(request.type);
                if (request.сonfirmed === true) {
                    $("#confirmed").attr("checked", "checked");
                } else {
                    $("#confirmed").removeAttr("checked");
                }
            },
            error: function () {
                toastr["error"]("Произошла ошибка при получении информации о файле");
            },
            beforeSend: function () {
                $("#progress").show();
            },
            complete: function () {
                $("#progress").hide();
            }
        });

        $("#Modal").modal('show');
    });
</script>

