@using PisMirShow.ViewModels;
@model User;
@{
    ViewData["Title"] = "Личный кабинет";
	List<StatisticsViewModel> statistics = ViewBag.Statistic;
}

<h1 class="mt-5">
    Профиль пользователя
    <a><i class="fas fa-user-edit" style="font-size:0.7em" onclick="GetUserById(@Model.Id)"></i></a>
</h1>
    <section>
        <div class="container">
            <div class="row">
                <div class="col-md-8">
                    <p class="mt-5">Имя: @Model.GetFullName()</p>
                    <p class="mt-3">
                        Роль в системе:
                        @(Model.RoleId == 1 ? "Пользователь" : "Администратор")
                    </p>
                    <p class="mt-3">Email: @Model.Email</p>
                    <p class="mt-3">Дата рождения: @Model.BirthdayDay</p>
                    <p class="mt-3">Должность: @Model.OfficePost</p>
                    <p class="mt-3">Отдел: @Model.Department</p>
                    <p class="mt-3">Номер телефона: @Model.Phone</p>
                    <p class="mt-3">Дата регистрации: @Model.RegisterTime</p>
                </div>
                <div class="col-md-4 mt-5 text-center">
                    <div style="background-image: url('https://sun9-50.userapi.com/c604828/v604828581/226f9/PL6DvrFtzJk.jpg'); background-size: cover; background-position:top center; width: 250px; height: 250px" class="rounded-circle"></div>
                </div>
            </div>
        </div>
    </section>

    <div class="modal" tabindex="-1" role="dialog" id="UserModal">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="FullName">Изменение данных</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label for="UserId" class="form-control-label">Id:</label>
                            <input type="text" class="form-control" id="UserId" readonly>
                        </div>
                        <div class="form-group">
                            <label for="EditFirstName" class="form-control-label">Имя:</label>
                            <input type="text" class="form-control" id="EditFirstName">
                        </div>
                        <div class="form-group">
                            <label for="EditLastName" class="form-control-label">Фамилия:</label>
                            <input type="text" class="form-control" id="EditLastName">
                        </div>
                        <div class="form-group">
                            <label for="EditOfficePost" class="form-control-label">Должность:</label>
                            <input type="text" class="form-control" id="EditOfficePost">
                        </div>
                        <div class="form-group">
                            <label for="EditUserDepartment" class="form-control-label">Отдел: </label>
                            <input type="text" class="form-control" id="EditUserDepartment">
                        </div>
                        <div class="form-group">
                            <label for="EditPhone" class="form-control-label">Номер телефона:</label>
                            <input type="text" class="form-control " id="EditPhone">
                        </div>
                        <div class="form-group">
                            <label for="EditEmail" class="form-control-label">Email:</label>
                            <input type="text" class="form-control" id="EditEmail">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
                    <button type="button" class="btn btn-primary" onclick="UpdateUserModal()">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

	<section>
		<script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>

		<div class="row mt-5">
			<div class="col-lg-6">
				<canvas class="m-auto" id="managerChart"></canvas>
			</div>
			<div class="col-lg-6 mt-5 mt-lg-0">
				<canvas class="m-auto" id="workerChart"></canvas>
			</div>
		</div>

		<script>
			var config = {
				type: 'doughnut',
				data: {
					datasets: [{
						data: [
							@(statistics[0].NotStarted),
							@(statistics[0].Active),
							@(statistics[0].Verification),
							@(statistics[0].Confirmed),
							@(statistics[0].Finished)
						],
						backgroundColor: [
							"#ff0000",
							"#ffa500",
							"#ffff00",
							"#008000",
							"#0000ff"
						],
						label: 'Manager Stat'
					}],
					labels: [
						'% NotStarted',
						'% Active',
						'% Verification',
						'% Confirmed',
						'% Finished'
					]
				},
				options: {
					responsive: true,
					legend: {
						position: 'top',
					},
					title: {
						display: true,
						text: 'Manager Statistics'
					},
					animation: {
						animateScale: true,
						animateRotate: true
					}
				}
			};

			var config1 = {
				type: 'doughnut',
				data: {
					datasets: [{
						data: [
							@(statistics[1].NotStarted),
							@(statistics[1].Active),
							@(statistics[1].Verification),
							@(statistics[1].Confirmed),
							@(statistics[1].Finished)
						],
						backgroundColor: [
							"#ff0000",
							"#ffa500",
							"#ffff00",
							"#008000",
							"#0000ff"
						],
						label: 'Worker Stat'
					}],
					labels: [
						'% NotStarted',
						'% Active',
						'% Verification',
						'% Confirmed',
						'% Finished'
					]
				},
				options: {
					responsive: true,
					legend: {
						position: 'top',
					},
					title: {
						display: true,
						text: 'Worker Statistics'
					},
					animation: {
						animateScale: true,
						animateRotate: true
					}
				}
			};

			window.onload = function() {
				var ctx = document.getElementById('managerChart').getContext('2d');
				window.myDoughnut = new Chart(ctx, config);

				var ctx1 = document.getElementById('workerChart').getContext('2d');
				window.myDoughnut1 = new Chart(ctx1, config1);
			};

		</script>


		@*https://www.chartjs.org/samples/latest/charts/line/stepped.html*@ 
		@*эффективность за неделю*@
		@*эффективность за месяц*@
		
		@*эффективность по компании топ (месяц, неделя, день)*@
	</section>

<script>
	function GetUserById(id) {
		$("#UserModal").modal("show");
		var data = new FormData();
		data.append("Id", id);
		$.ajax({
			type: "POST",
			url: "@Url.Action("GetCurrentUserByIdJson","Home")",
			contentType: false,
			processData: false,
			data: data,
			success: function(data) {
				$("#EditFirstName").val(data.firstName);
				$("#EditLastName").val(data.lastName);
				$("#UserId").val(data.id);
				$("#EditOfficePost").val(data.officePost);
				$("#EditUserDepartment").val(data.department);
				$("#EditPhone").val(data.phone);
				$("#EditEmail").val(data.email);
			},
			error: function(request) {
				console.log(request);
				toastr["error"](request.message);
			}
		});
	};

	function UpdateUserModal() {
		var data = new FormData();
		data.append("Id",  $("#UserId").val());
		data.append("FirstName", $("#EditFirstName").val());
		data.append("LastName", $("#EditLastName").val());
		data.append("OfficePost", $("#EditOfficePost").val());
		data.append("Department", $("#EditUserDepartment").val());
		data.append("Phone", $("#EditPhone").val());
		data.append("Email", $("#EditEmail").val());
		$.ajax({
			type: "POST",
			url: "@Url.Action("UpdateUser","Home")",
			contentType: false,
			processData: false,
			data: data,
			success: function(data) {
				toastr["success"]("Запись изменена");
				$("#UserModal").modal("hide");
				setTimeout(location.reload(), 3000);
			},
			error: function(request) {
				toastr["error"](request.message);
			}
		});
	};

</script>