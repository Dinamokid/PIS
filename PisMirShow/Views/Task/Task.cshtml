@model TaskItem;
@{
    ViewData["Title"] = "Задание " + '"' + @Model.Title + '"';
    var user = (User)ViewBag.User;
}

@* чат системадиалогов* *@


<partial name="../Particles/_FileInteraction" />
<partial name="../Particles/_FileDroper" />

<section>
    <h1 class="mt-3">@Model.Title</h1>
    <p>Дата создания: @Model.StartDate</p>
    <p>Статус: <span id="status">@Model.Status.GetDisplayName()</span></p>
    <p>От кого: @Model.FromUser.GetFullName()</p>
    <p>Кому: @Model.ToUser.GetFullName()</p>
    <p>DeadLine: @Model.DeadLine</p>
    <p>Текст задачи: @Model.Text</p>

    <div class="row mt-2" id="FilesList">
        @foreach (var temp in Model.Files)
        {
            <div class="File @(temp.Confirmed == true? "Confirmed":"") col-6 col-sm-3 col-lg-2 text-center mt-3" onclick="EditFile(@temp.Id)">
                <i class="fas fa-check-circle position-absolute" style="right: 36%; top: -12px; color: greenyellow;"></i>
                <i class="fas fa-file" style="font-size: 30px"></i>
                <p class="name">
                    @temp.Name
                </p>
            </div>
        }
    </div>

    <div>
        <div id="fileBasket" class="filebasket">
            <i class="fas fa-cloud-upload-alt"></i>
        </div>
    </div>
    
    <div class="d-flex">
        <div class="mt-3 mb-4 mr-2">
            <a class="btn btn-dark" href="@Url.Action("EditTask", "Task", new { id = Model.Id })">Редактировать задание</a>
        </div>
        <div class="setStatus row mt-3 mb-4">
            <div class="container">
                @if (Model.Status != TaskItem.TaskStatus.Active)
                {
                    <button class="btn btn-dark" onclick="SetTaskStatus(1)">Активировать</button>
                }
                @if (Model.Status >= TaskItem.TaskStatus.Active && Model.Status != TaskItem.TaskStatus.Paused)
                {
                    <button class="btn btn-dark" onclick="SetTaskStatus(2)">Остановить</button>
                }
                @if (Model.Status >= TaskItem.TaskStatus.Active && Model.Status != TaskItem.TaskStatus.Сonfirmed)
                {
                    <button class="btn btn-dark" onclick="SetTaskStatus(3)">Подтвердить</button>
                }
                @if (Model.Status >= TaskItem.TaskStatus.Сonfirmed && Model.Status != TaskItem.TaskStatus.Finished)
                {
                    <button class="btn btn-dark" onclick="SetTaskStatus(4)">Завершить</button>
                }
            </div>
        </div>
    </div>

</section>
<section>
    <div class="comments mt-2">
        <div class="commentsList">
            @foreach (var temp in Model.Comments)
            {
                <div class="comment mt-3">
                    <div class="border-bottom">@temp.User.GetFullName()</div>
                    <div class="d-flex justify-content-between">
                        <div class="pr-2">@temp.Text</div>
                        <div class="text-nowrap">@temp.CreateDate.ToString("f")</div>
                    </div>
                </div>
            }
        </div>
        <div class="addComments mt-4">
            <div>
                <label for="commentInput">Добавить комментарий:</label>
                <input type="text" class="form-control" id="commentInput" />
            </div>
            <div>
                <button class="btn-dark btn mt-2" onclick="addComment()">Отправить</button>
            </div>
        </div>
    </div>
</section>


<script>
    function SetTaskStatus(status) {
        var data = new FormData();
        data.append("status", status);
        data.append("taskId", @Model.Id);

         $.ajax({
            type: "POST",
            url: "@Url.Action("SetTaskStatus", "Task")",
            contentType: false,
            processData: false,
            data: data,
            success: function () {
                setTimeout("location.reload();", 300);
            },
            error: function () {
	            toastr["error"]("Произошла ошибка при смене статуса");
            },
            beforeSend: function () {
                $("#progress").show();
            },
            complete: function () {
                $("#progress").hide();
            }
        });
    }

    function addComment() {
        var data = new FormData();
        data.append("taskId", @Model.Id);
        data.append("text", $("#commentInput").val());
        data.append("userId", @user.Id);

        $.ajax({
            type: "POST",
            url: "@Url.Action("AddCommentInTask","Task")",
            contentType: false,
            processData: false,
            data: data,
            success: function (names) {
                $(".commentsList").append(`
                <div class="comment mt-3">
                    <div class="border-bottom">@user.GetFullName()</div>
                    <div class="d-flex justify-content-between">
                        <div class="pr-2">`+ $("#commentInput").val() +`</div>
                        <div class="text-nowrap">@DateTime.UtcNow.ToString("f")</div>
                    </div>
                </div>`);
                $("#commentInput").val("");
            },
            error: function () {
                toastr["error"]("Произошла ошибка при загрузке файлов");
            },
            beforeSend: function () {
                $("#progress").show();
            },
            complete: function () {
                $("#progress").hide();
            }
        });
    }
</script>